name: Coverage Gate

on:
  workflow_call:
    inputs:
      artifact_id:
        description: "Unused, kept for consistency with parent"
        required: true
        type: string

jobs:
  coverage_gate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download coverage HTML artifact
        uses: actions/download-artifact@v4
        with:
          name: code-coverage-report
          path: coverage_html

      - name: Debug list coverage files
        run: |
          echo "=== coverage_html contents ==="
          ls -R coverage_html

      - name: Enforce coverage threshold
        run: |
          THRESHOLD=99
          COVERAGE_LINE=$(grep -oE "Lines:[^%]*[0-9]+\.[0-9]+%" -m 1 coverage_html/index.html || true)
          echo "Found line: $COVERAGE_LINE"

          if [ -z "$COVERAGE_LINE" ]; then
            echo "Could not find coverage summary in index.html"
            exit 1
          fi

          # Prozentzahl extrahieren
          LINE_COV=$(echo "$COVERAGE_LINE" | grep -oE "[0-9]+\.[0-9]+")
          echo "Line coverage extracted: ${LINE_COV}% (threshold: ${THRESHOLD}%)"

          # Ganzzahl vergleichen
          if [ "${LINE_COV%.*}" -lt "$THRESHOLD" ]; then
            echo "Coverage below threshold, failing job."
            exit 1
          fi

          echo "Coverage is above threshold."
